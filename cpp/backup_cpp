# include <string.h>
# include <fstream>
# include "DxLib.h"
# include "config.hpp"
# include "player.hpp"

/* ----------------
	public
------------------- */

// --- read & write file ---

void Config::ReadParameter(int *speed, int angular[3]) {

	try{
		std::ifstream ifs("../etc/config");
		int n;

		// move speed
		ifs >> *speed;

		// rotate speed
		for (int i = 0; i < 3; i++) {
			ifs >> angular[i];
		}
	}
	catch (char* s) {

		// default value
		*speed = 3;
		angular[0] = 5;
		angular[1] = 5;
		angular[2] = 5;
	}

	return;
}


void Config::WriteParameter(int *speed, int angular[3]) {

	try {
		// write file
		std::ofstream ofs("../erc/config");
		ofs << *speed << std::endl;
		ofs << angular[0] << std::endl;
		ofs << angular[1] << std::endl;
		ofs << angular[2] << std::endl;
	}
	catch (char* s) {

		// default value
		*speed = 3;
		angular[0] = 5;
		angular[1] = 5;
		angular[2] = 5;
	}

	return;
}




// --- config UI ---

int Config::ConfigTitle() {

	return 0;

	Init();
	SetStringInformation();

	Draw();

	bool isLoop = true;
	while (isLoop) {
		isLoop = Select();

		// break in abnormal end
		if (ProcessMessage() == -1) break;
	}

	End();

	// start game
	if (select == 0) return 1;

	return -1;
}

int Config::ConfigGame() {

	Init();
	SetStringInformation();

	Draw();

	bool isLoop = true;
	while (isLoop) {
		isLoop = Select();

		// break in abnormal end
		if (ProcessMessage() == -1) break;
	}

	End();

	// start game
	if (select == 0) return 1;

	return -1;
}




/* ------------------
	private
--------------------- */
void Config::Init() {

	fontHandle = CreateFontToHandle(NULL, fontSize, fontThick);
	white = GetColor(255, 255, 255);

	return;
}


void Config::SetStringInformation() {

	int sx, sy;
	GetScreenState(&sx, &sy, NULL);

	int xMin = 9999;
	for (int i = 0; i < 3; i++) {

		// set strPos
		int x;
		int w = GetDrawStringWidthToHandle(str[i], strlen(str[i]), fontHandle);
		x = (sx - w) / 2;
		strPos[i][0] = x;

		int y;
		y = sy / (3 + 1) * (i+1) - fontSize / 2;
		strPos[i][1] = y;

		// prepare creating arrowPos
		if (xMin > x) xMin = x;
	}
	
	// set arrowPosX
	int x;
	int w = GetDrawStringWidthToHandle(arrow, strlen(arrow), fontHandle);
	x = xMin - w;
	arrowPosX = x;

	return;
}


bool Config::Select() {

	int key = WaitKey();

	// change scene
	if (key == KEY_INPUT_SPACE || key == KEY_INPUT_RETURN) {
		return false;
	}

	// move arrow & update screen
	else if (key == KEY_INPUT_UP) {
		if (select > 0) {
			select--;
			Draw();
		}
	}

	else if (key == KEY_INPUT_DOWN) {
		if (select < 3 - 1) {
			select++;
			Draw();
		}
	}

	return true;
}


void Config::Draw() {

	ClearDrawScreen();

	// string
	for (int i = 0; i < 3; i++) {
		DrawStringToHandle(strPos[i][0], strPos[i][1], str[i], white, fontHandle);
	}

	// arrow
	DrawStringToHandle(arrowPosX, strPos[select][1], arrow, white, fontHandle);

	ScreenFlip();

	return;
}


void Config::End() {

	DeleteFontToHandle(fontHandle);

	return;
}
